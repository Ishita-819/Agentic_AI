<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agentic scRNA-seq Analysis</title>
 

    
  
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div class="container">
  <header>
    <h1>ðŸ§  Agentic AI for snRNA-seq Analysis</h1>
    <p class="subtitle">Automated clustering, DEG, trajectory inference & hypothesis generation</p>
  </header>

  <section class="controls">
    <button id="runBtn" onclick="runAnalysis()">Run Analysis</button>
    <span id="status"></span>
  </section>

  <section class="grid">
    <div class="card" id="pipeline"></div>
    <div class="card" id="hypotheses"></div>
  </section>

  <section class="card" id="nextSteps"></section>
  <section class="card" id="results"></section>
</div>


<script>
const API = "http://localhost:8000";

async function runAnalysis() {
  const btn = document.getElementById("runBtn");
  btn.classList.add("disabled");
  btn.innerText = "Running...";

  // Start background job
  const res = await fetch(`${API}/run-analysis`, { method: "POST" });
  const job = await res.json();
  if (!job || !job.job_id) {
    document.getElementById('results').innerHTML = '<p style="color:red">Failed to start job</p>';
    btn.classList.remove('disabled');
    btn.innerText = 'Run Analysis';
    return;
  }

  const jobId = job.job_id;
  document.getElementById('results').innerHTML = `<p>Job started: ${jobId}</p>`;

  // Poll for completion
  const pollInterval = 1500; // ms
  const poll = setInterval(async () => {
    const s = await fetch(`${API}/status/${jobId}`);
    const status = await s.json();
    if (status && status.status === 'finished') {
      clearInterval(poll);
      const r = await fetch(`${API}/result/${jobId}`);
      const resp = await r.json();
      
      if (resp && resp.result) {
  // Support both wrapped and unwrapped shapes    
        const data = resp.result.result || resp.result;

        // ---- Pipeline status ----
        if (data.pipeline) {
          document.getElementById("pipeline").innerHTML = `
            <h2>Pipeline Progress</h2>
            <ul>
              ${Object.entries(data.pipeline)
                .map(([k, v]) => `<li>${k.replace(/_/g, " ")} ${v === "done" ? "âœ”" : v}</li>`)
                .join("")}
            </ul>
          `;
        }

  // ---- Hypotheses ----
        document.getElementById("hypotheses").innerHTML = `
          <h2>Generated Hypotheses</h2>
          ${
            data.hypotheses && data.hypotheses.length
              ? data.hypotheses.map((h) => `<p>${h}</p>`).join("")
              : "<p>No hypotheses returned</p>"
          }
        `;

  // ---- Next Steps Buttons ----
          document.getElementById("nextSteps").innerHTML = `
            <h2>Suggested Next Steps</h2>
            ${
              data.next_steps && data.next_steps.length
                ? data.next_steps
                    .map(
                      (s) =>
                        `<button onclick="runNextStep('${s.replace(/'/g, "\\'")}')">${s}</button>`
                    )
                    .join("<br>")
                : "<p>No next steps returned</p>"
            }
          `;

          btn.innerText = "Analysis Completed";
          btn.classList.remove("disabled");
      } else {
          document.getElementById("results").innerHTML =
            '<p style="color:red">Job completed but no results</p>';
          btn.classList.remove("disabled");
          btn.innerText = "Run Analysis";
      }

    } else if (status && status.status === 'failed') {
      clearInterval(poll);
      document.getElementById('results').innerHTML = `<p style="color:red">Job failed: ${status.error || 'unknown'}</p>`;
      btn.classList.remove('disabled');
      btn.innerText = 'Run Analysis';
    } else {
      // still running; optionally update a small status indicator
      document.getElementById('results').innerHTML = `<p>Job ${jobId} status: ${status.status}</p>`;
    }
  }, pollInterval);
}

async function runNextStep(step) {
  document.getElementById("results").innerHTML = "<p>Running selected analysisâ€¦</p>";

  const res = await fetch(`${API}/run-next-step`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ suggestion: step })
  });

  const data = await res.json();

  document.getElementById("results").innerHTML = `
    <h2>Result: ${data.suggestion}</h2>
    <h3>Biological Interpretation</h3>
    <pre>${ data.biological_interpretation}</pre>
    
  `;

  document.getElementById("nextSteps").innerHTML = `
            <h2>Suggested Next Steps</h2>
            ${
              data.next_steps && data.next_steps.length
                ? data.next_steps
                    .map(
                      (s) =>
                        `<button class="next-step-btn" onclick="runNextStep('${s.replace(/'/g, "\\'")}')">${s}</button>`
                    )
                    .join("<br>")
                : "<p>No next steps returned</p>"
            }
          `;
}
</script>

</body>
</html>